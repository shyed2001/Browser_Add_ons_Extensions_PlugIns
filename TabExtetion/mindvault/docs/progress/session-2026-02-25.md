# MindVault — Session Log: 2026-02-25 (Session 4)
_Phase 3 — Firefox fix + Companion Web Dashboard + Multi-browser Support_

---

## Session Goals
1. Fix Firefox popup: tabs not detected/listed
2. Make extension work across all major browsers
3. Phase 3 Step 3: companion web UI (HTML/CSS/JS embedded in EXE)
4. Update multi-browser installer (Brave, Opera, Vivaldi, etc.)

---

## Architecture Decision: Drop MAUI, use companion web UI

**Before:** Extension + Companion (REST only) + MAUI Desktop = 3 installs, Windows-only
**After:** Extension + Companion (REST + built-in web UI at /ui/) = 2 installs, any browser

Rationale:
- The companion EXE already has an HTTP server; serving static files is trivial (Go embed)
- PWA manifest makes it installable as a "desktop app" from any browser
- No .NET/MAUI complexity; same vanilla HTML/JS/CSS stack as extension dashboard
- Works on future Mac/Linux companions too

MAUI scaffold (`desktop/`) kept in repo — not deleted, just deprioritised.

---

## Work Completed

### Firefox popup tab fix (SOLVED-013, commit 481f662)

**Root cause 1:** `chrome.tabs.query({ currentWindow: true })` in Firefox MV2 popup
resolves `currentWindow` to the popup's own window (0 tabs), not the browser window.
**Root cause 2:** `tab.url` undefined without `*://*/*` host permission.

**Fixes applied:**
- `popup/index.ts`: `browser.tabs.query({ lastFocusedWindow: true })` (cross-browser safe)
- `popup/index.ts`: explicit `import browser from 'webextension-polyfill'`
- `popup/index.ts`: filter `moz-extension://`, `edge://`, `opera://`, `brave://`, `vivaldi://`
- `manifest-firefox.json`: added `"*://*/*"` and `"file:///*"` to permissions

### CORS fix for Firefox extension sync (SOLVED-014, commit fa0ea80)

Firefox extension origin is `moz-extension://` — old companion CORS only allowed `chrome-extension://`.
Updated `corsMiddleware` to reflect origin for all extension schemes + local HTTP origins.

### Phase 3 Step 3: Companion web dashboard (commit fa0ea80)

Files created in `companion/internal/api/ui/`:
- `index.html` — SPA shell: sidebar, sessions panel, tabs panel, welcome, new-lib modal
- `style.css` — dark theme (--bg #0f0f10, --accent #7c6aff), responsive, RGYB dots
- `app.js` — vanilla JS: boot (GET /token), libraries, sessions, tabs, live search, create lib
- `manifest.json` — PWA manifest for "Add to desktop" install

`server.go` changes:
- `//go:embed ui` + `fs.Sub` + `http.FileServer` on `/ui/`
- Redirects `/` → `/ui/` and `/ui` → `/ui/`
- CORS updated (see above)

### Multi-browser installer update

`C:\Temp\install-mv-companion.ps1` now detects and registers native messaging for:
Chrome, Chrome Beta/Dev, Chromium, Edge, Edge Beta, Brave, Opera, Opera GX, Vivaldi, Arc

---

## Test Results
```
TypeScript:   116 tests, 0 failures (7 test files)
Go companion:  27 tests, 0 failures (19 API + 8 DB)
Chrome build:  40 modules → dist/
Firefox build: 41 modules → dist-firefox/
Total: 143 passing, 0 failed
```

## Verification
```
GET /ui/       → 200 (MindVault title, app.js linked)
GET /          → 301 → /ui/
GET /ui/app.js → 200, 9177 bytes
GET /health    → {"status":"ok","version":"0.1.0"}
GET /token     → {"token":"2adcf18fc4d9..."}
```

---

## Commits
| Hash | Message |
|------|---------|
| `481f662` | fix(firefox): popup tabs empty + add host permissions |
| `fa0ea80` | feat(ui): companion web dashboard at /ui/ (Phase 3 Step 3) |
| `(docs)` | docs: session 4 log + CHANGELOG + PLAN + ISSUES update |

---

## Next Steps (Phase 3 continuation)
1. **Step 4** — Web UI: Bookmarks view, History view, Downloads view
2. **Step 5** — Web UI: Global search across all libraries
3. **Step 6** — Web UI: Settings page (companion status, browser connections)
4. **Step 7** — PWA service worker (offline cache + install prompt)
5. **Step 8** — Smart installer: opens extension store page per detected browser
6. **Step 9** — DELETE handlers in companion (currently 501)
7. **Step 11** — Companion auto-start on login (Task Scheduler)
