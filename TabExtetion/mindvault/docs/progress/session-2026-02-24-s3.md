# MindVault — Session Log: 2026-02-24 (Session 3)
_Phase 3 — Extension → Companion Sync Pipeline_

---

## Session Goals
1. Diagnose and fix Firefox "add-on is corrupt" error (carried from session 2)
2. Answer user architecture question: how does multi-browser data aggregate?
3. Implement the extension → companion sync pipeline (chosen by user)

---

## Work Completed

### Firefox "add-on is corrupt" fix (SOLVED-012)
Two stacked root causes found and fixed:
1. **Wrong file to load**: setup guide said load `manifest-firefox.json` from *source* —
   Firefox cannot run TypeScript. Fixed docs to say load `dist-firefox/manifest.json`.
2. **`options_page` field ignored**: same issue as SOLVED-001 (Chrome). Changed to
   `options_ui.page` in `manifest-firefox.json`.
3. **New `vite.config.firefox.ts`** — Firefox MV2 build config outputting to `dist-firefox/`.
4. **New `build:firefox` npm script** in `packages/extension/package.json`.
- Build result: 40 → 41 modules (companion-client chunk included after sync pipeline work).
- Commit: `3ee38fd`

### Multi-browser architecture explanation
Each browser (Chrome profile 1, Chrome profile 2, Edge, Firefox) has its own isolated
IndexedDB. The companion is the aggregation hub — all browser extensions push data to it
via REST HTTP. MAUI desktop reads from companion's SQLite. This gives one unified view
across all browsers on one PC. Phase 4 (cloud) will handle cross-device.

### Extension → Companion Sync Pipeline (commit 97f0b45)

#### Companion changes
- `handlers.go`: Added `token string` field, `GetToken` handler (unauthenticated),
  `idOrNew()` helper, optional `id` field to all 3 create request structs,
  `tabCount` to `createSessionReq`.
- `server.go`: Passes token to `handlers.New(db, token)`, registers `GET /token`
  without auth middleware.

#### Extension changes (new file + 2 modified)
- `services/companion-client.ts` (NEW — 172 lines):
  - `bootstrapCompanion()` — fetch token, check/create library in companion
  - `pushSession()` / `pushTabs()` — fire-and-forget push after every Save All
  - `clearCompanionToken()` — for future logout/reset flow
  - Token cached in `chrome.storage.local` under `mv_companion_token`
- `background/index.ts` — calls `bootstrapCompanion()` on startup with correct
  field mapping (`encryptionEnabled` → `isEncrypted`, `encryptionSalt` → `passwordSalt`)
- `popup/index.ts` — after IDB write, fires `pushSession()` + `pushTabs()`; uses
  `SavedTab.favicon` (correct field name, confirmed vs `@mindvault/shared` entities)

#### Key design decisions
- **Fire-and-forget**: all companion calls are `void` — extension works offline
- **ID preservation**: companion `idOrNew()` uses extension's IDB IDs when provided
  so records have the same IDs in both stores
- **Bootstrap pattern**: extension fetches token on startup via unauthenticated
  `GET /token` (safe: companion binds to 127.0.0.1 only)

---

## Test Results
```
TypeScript extension:  116 tests, 0 failures (7 test files)
Go companion:          27 tests, 0 failures (19 API + 8 DB, cached)
Chrome build:          40 modules → dist/
Firefox build:         41 modules → dist-firefox/
Companion health:      {"status":"ok","version":"0.1.0"}
Token endpoint:        {"token":"2adcf18fc4d9ffb7cb5ef6c3c32553c4fa49f286f9c39ceadc8926b64693b83d"}
Total:                 143 tests passing, 0 failed
```

---

## Commits
| Hash | Message |
|------|---------|
| `3ee38fd` | fix(extension): add proper Firefox MV2 build + fix corrupt addon error |
| `97f0b45` | feat(sync): extension → companion push pipeline |

---

## Issues Resolved
- SOLVED-012: Firefox "add-on is corrupt" + missing dashboard
- SOLVED-009: Unicode characters in PowerShell installer (ongoing workaround)

---

## Known Open Issues After Session
- ISSUE-001: Companion not auto-started on login (workaround: manual start or install-ps1)
- ISSUE-002: Native messaging wildcard origin (dev-only; fix before production)
- ISSUE-003: No visual feedback in popup when companion is offline

---

## Next Steps (Phase 3 continuation)
1. **Step 3 — MAUI Libraries page**: wire "Create Library" button to `POST /libraries`
2. **Step 4 — MAUI Sessions page**: list sessions with tab counts
3. **Step 5 — MAUI Tabs page**: search + RGYB colour filter
4. **Dashboard combined view**: once companion has data from all browsers, the
   MAUI desktop can show unified library across Chrome, Edge, Firefox
5. **DELETE handlers in companion** (currently 501 Not Implemented)
