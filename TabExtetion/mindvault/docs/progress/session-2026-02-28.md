# Session Log — 2026-02-28

## Scope
v4.2.0 — Theme switcher, library inline rename, auto-rename fix

## Completed

### 1. Auto-rename fix (handlers.go)
- **Bug**: `count == 1` condition meant rename only fired on very first push to a library.
  Libraries with existing sessions never got renamed even when SourceBrowser was set.
- **Fix**: removed the count guard entirely — any push from a known browser to a "Default Library"
  triggers `RenameLibrary(id, "Default ("+browser+")")`.
- File: `companion/internal/api/handlers/handlers.go` line ~228.

### 2. PATCH /libraries/{id} endpoint
- New handler `PatchLibrary` + `patchLibraryReq{Name *string}` in handlers.go.
- Route registered in `server.go` between GET and DELETE.
- Returns 204 No Content; calls existing `db.RenameLibrary()`.

### 3. Theme switcher — style.css
- Added 3 `:root[data-theme="…"]` override blocks after responsive media query:
  - `mid-dark`: #1e1e2e bg family, #cdd6f4 text
  - `mid-light`: #e8e8f0 bg family, #1a1a2e text, adjusted accent
  - `light`: #f5f5f7 bg family, #1c1c1e text, adjusted accent
- Added `.theme-switcher`, `.theme-btn`, `.theme-btn.active` styles.
- Added `.lib-rename-input` style (accent-bordered inline input).

### 4. Theme switcher + library rename — app.js
- `boot()`: restores `localStorage('mv-theme')` to `document.documentElement.dataset.theme`
  before first render.
- `renderSettings()`: added Appearance card HTML with 4 `.theme-btn[data-theme]` buttons.
- After `wireImportCard()`: wires theme buttons — sets `dataset.theme`, saves to localStorage,
  toggles `.active` class.
- `renderLibraries()`: added dblclick listener on `.lib-name` → `startLibRename(el, lib)`.
- New `startLibRename()` function: replaces span with `.lib-rename-input`, Enter/blur commits
  via `apiPatch('/libraries/{id}', {name})`, Escape cancels, both call `loadLibraries()`.

## Test Results
- 116 TS tests: PASS (vitest run, packages/extension)
- 27 Go tests: PASS (go test ./..., companion/)
- Companion build: OK (mvaultd.exe rebuilt, installed to %LOCALAPPDATA%\MindVault\bin\)
- Preview verified: theme switches live, library rename input appears on dblclick

## Files Changed
- `companion/internal/api/handlers/handlers.go`
- `companion/internal/api/server.go`
- `companion/internal/api/ui/style.css`
- `companion/internal/api/ui/app.js`
- `CHANGELOG.md` (added v4.2.0 entry)

---

## Scope (continued)
v4.2.1 — SW cache fix, no-cache middleware, retroactive library rename, All Tabs rich table

## Completed

### 5. Root cause analysis — stale UI from SW cache
- After installing updated binary, companion UI still showed OLD layout (3 nav buttons, no
  theme switcher) because `sw.js` had `CACHE_NAME = 'mv-ui-v1'` with cache-first strategy.
- Browser served stale `app.js`/`style.css`/`index.html` from the v1 cache, ignoring the
  new embedded assets entirely.
- Confirmed: force-refresh showed 5 nav buttons (index.html served fresh) but theme switcher
  still missing (app.js still old).

### 6. SW cache fix (sw.js)
- `CACHE_NAME` bumped from `'mv-ui-v1'` → `'mv-ui-v4'`.
- Browser detects the changed sw.js → installs new SW → deletes old cache → fresh assets.

### 7. Cache-Control: no-cache middleware (server.go)
- Added `noCacheUI(next http.Handler) http.Handler` middleware.
- Sets `Cache-Control: no-cache, must-revalidate` on all `/ui/` responses.
- FileServer wrapped: `mux.Handle("/ui/", noCacheUI(http.StripPrefix("/ui/", ...)))`.
- Prevents stale-cache recurrence after future binary updates.

### 8. MigrateDefaultLibraryNames() (sqlite.go + main.go)
- New `func (d *DB) MigrateDefaultLibraryNames() error` in sqlite.go:
  - Queries all libraries still named exactly `"Default Library"`.
  - For each: finds dominant `source_browser` from its sessions (GROUP BY + COUNT ORDER BY).
  - Renames to `"Default (Chrome)"` / `"Default (Firefox)"` etc via `RenameLibrary()`.
  - Idempotent — skips if no sessions with source_browser found.
- Called in `main.go` immediately after `database.Migrate()` (non-fatal warning on error).

### 9. All Tabs rich table (app.js + style.css + index.html + sqlite.go)
- **sqlite.go**: `Tab` struct extended with `SessionName *string`, `LibraryName *string`,
  `SourceBrowser *string` (JSON-omitempty). `ListAllTabs()` rewritten with LEFT JOINs on
  `sessions` and `libraries` to populate these fields.
- **style.css**: added `.tab-table-wrap`, `.tab-table-hdr`, `.tab-table-row`,
  `.tt-fav`, `.tt-title`, `.tt-domain`, `.tt-session`, `.tt-lib`, `.tt-browser`, `.tt-date`.
  7-column CSS grid: `12px 1fr 120px 130px 110px 90px 80px`.
- **index.html**: `masterTabsPanel` container changed from `class="tab-list"` →
  `class="tab-table-wrap"`.
- **app.js**:
  - State: `masterTabSortCol = 'savedAt'`, `masterTabSortDir = 'desc'`.
  - `loadMasterTabs()` refactored; search filters on title, URL, domain, sessionName,
    libraryName, sourceBrowser.
  - New `renderMasterTabsTable(tabs)`: 7-col sortable grid with colour, favicon+title+URL,
    domain, session (clickable → selectLibrary), library, browser, date columns.
  - New `domainOf(url)` shared helper (replaces inline IIFE in `renderTabs()`).

## Verification
- Build: `go build ./cmd/mvaultd` — EXIT 0
- Tests: `go test -count=1 ./...` — 27/27 PASS
- Binary installed: `%LOCALAPPDATA%\MindVault\bin\mvaultd.exe`
- Preview browser confirmed (after SW unregister + cache clear + reload):
  - `hasMasterTabSortCol: true`, `hasRenderMasterTabsTable: true`, `hasDomainOf: true`
  - 5 nav buttons present
  - All Tabs: 331 tabs, cols [Title, Domain, Session, Library, Browser, Saved ▼]
  - First row: domain=chatgpt.com, session="Session — 2/28/2026", lib="Default (Firefox)",
    browser="Firefox"

## Files Changed (v4.2.1)
- `companion/internal/api/ui/sw.js`
- `companion/internal/api/server.go`
- `companion/internal/db/sqlite.go`
- `companion/cmd/mvaultd/main.go`
- `companion/internal/api/ui/style.css`
- `companion/internal/api/ui/app.js`
- `companion/internal/api/ui/index.html`
- `CHANGELOG.md` (added v4.2.1 entry)
- `docs/ISSUES.md` (added ISSUE-011)
- `docs/SOLVED_ISSUES.md` (added SOLVED-015)

---

## v4.3.0 — Column Resize, Library Context Menu, Export Enhancements, Notes Editing

### Completed

**Go Backend**
- `sqlite.go`: `TabPatch` struct, `OsUsername()`, `UpdateTab()`, `MigrateDefaultLibraryNamesAs(username)`.
  Default library name format: "Default (Chrome — DellVostro)" (includes OS username).
- `handlers.go`: `PatchTab` (PATCH /tabs/{id}), `DeleteTabByID` (DELETE /tabs/{id}), updated auto-rename.
- `server.go`: 2 new routes registered.

**Companion UI**
- `index.html`: Export toolbar, 11-checkbox column visibility menu, library right-click context menu, ISSUE-011 notice.
- `style.css`: 11-column CSS custom property grid, text wrap, sticky header, resize handle, toolbar/menu/notice/notes/actions styles.
- `app.js`: Full `renderMasterTabsTable` replacement (11 cols, notes, open/delete, repeats). Helper functions:
  `applyColWidthsToCSS`, `wireResizeHandles`, `wireTabsToolbar`, `wireLibContextMenu`,
  `showLibCtxMenu`, `masterTabsExport`, `dlBlob`. Library right-click wired. ISSUE-011 notice shown.

**Extension**
- `export.ts`: `exportText()` added (Title TAB URL, plain text).
- `dashboard.html`: Export Text button, `.th-resize-handle` spans in all `<th>` cells.
- `dashboard.css`: `th { position:relative }`, resize handle styles, text-wrap for col-title/col-url.
- `dashboard/index.ts`: `wireTableResize()` with pointer-event drag + localStorage persistence; `exportText` wired.

### Test Results
- Go: 27/27 PASS
- TS: 116/116 PASS
- Extension build: 40 modules, EXIT 0

### Files Modified
- `companion/internal/db/sqlite.go`
- `companion/internal/api/handlers/handlers.go`
- `companion/internal/api/server.go`
- `companion/internal/api/ui/index.html`
- `companion/internal/api/ui/style.css`
- `companion/internal/api/ui/app.js`
- `packages/extension/src/services/export.ts`
- `packages/extension/src/dashboard/dashboard.html`
- `packages/extension/src/dashboard/dashboard.css`
- `packages/extension/src/dashboard/index.ts`
- `CHANGELOG.md` (prepended v4.3.0 entry)
